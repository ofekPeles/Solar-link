<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar View â€“ ×”×•×¡×¤×ª ×ª××•× ×” ×œ××¡×“ × ×ª×•× ×™×</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root {
      --brand: #1e6f5c;
      --brand-2: #4ecca3;
      --bg: #e3f6f5;
      --text: #233142;
    }
    body {
      background: linear-gradient(135deg, var(--bg) 0%, #f7fafc 100%);
      font-family: 'Heebo', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--text);
    }
    header {
      text-align: center;
      padding: 1.5rem 0 0.5rem;
    }
    .brand-title {
      font-weight: 700;
      color: var(--brand);
    }
    .subtitle {
      color: #5c6b73;
    }
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    .card-title i { color: var(--brand); }
    .btn-primary {
      background: var(--brand);
      border-color: var(--brand);
      font-weight: 600;
      border-radius: 10px;
    }
    .btn-primary:disabled { opacity: .8; }
    .btn-outline-secondary { border-radius: 10px; }
    .form-control, .form-select { border-radius: 10px; }
    .preview-box {
      background: #f7fafc;
      border: 1px solid #b8e0d2;
      border-radius: 10px;
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .preview-box img { max-height: 320px; object-fit: contain; }
    .kpi {
      text-align: center;
      padding: 12px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e8f3ef;
    }
    .kpi h6 { color: #6b7c85; margin-bottom: 6px; }
    .kpi .val { font-size: 1.25rem; font-weight: 700; color: var(--brand); }
    .results-tabs .nav-link { color: var(--brand); font-weight: 600; }
    .results-tabs .nav-link.active { background: var(--brand); color: #fff; }
    .img-fit { width: 100%; height: auto; border-radius: 10px; border: 1px solid #e8f3ef; background:#fff; }
    .fade-in { animation: fade .35s ease-in-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: none; } }
    .small-note { font-size: .85rem; color: #6c757d; }
  </style>
</head>
<body>

  <header class="container">
    <h1 class="brand-title">Solar View</h1>
    <p class="subtitle">×“×£ ××“××™×Ÿ ×œ×”×¢×œ××ª ×ª××•× ×ª ×’×’ + ×¤×¨×˜×™ ×—×©×‘×•×Ÿ ×•×—×™×©×•×‘ ×¤×•×˜× ×¦×™××œ ×¡×•×œ××¨×™</p>

      <div class="d-flex justify-content-center mt-2">
    <a href="/search" class="btn btn-outline-secondary">
      <i class="bi bi-search me-1"></i> ×—×™×¤×•×© ×œ×¤×™ ×›×ª×•×‘×ª/×©×
    </a>
  </div>
  </header>

  <main class="container my-3">
    <div class="row g-4">

      <!-- Left column: Form -->
      <div class="col-lg-5">
        <div class="card p-3 p-md-4 mb-3">
          <h5 class="card-title mb-3"><i class="bi bi-upload me-2"></i>×”×¢×œ××ª ×ª××•× ×” ×•×¤×¨×˜×™×</h5>

          <div class="mb-3">
            <label class="form-label">×©× ×¤×¨×•×™×§×˜ (×œ× ×—×•×‘×”, ×œ×©××™×¨×”)</label>
            <input id="projectName" type="text" class="form-control" placeholder="×œ××©×œ: Rooftop â€“ Herzl 5" />
          </div>

          <div class="mb-3">
            <label class="form-label">×ª××•× ×ª ×’×’ (×—×•×‘×”)</label>
            <input id="imageInput" type="file" accept="image/*" class="form-control" />
            <div class="preview-box mt-2"><img id="imagePreview" alt="×ª×¦×•×’×” ××§×“×™××”" /></div>
            <div class="small-note mt-1">×”×ª××•× ×” ×ª×•×¦×’ ××™×™×“×™×ª ×œ× ×•×—×•×ª×š. ×§×‘×¦×™ PNG/JPG ××•××œ×¦×™×.</div>
          </div>

          <div class="row g-3">
            <div class="col-sm-8">
              <label class="form-label">×¨×—×•×‘ ×•××¡×¤×¨</label>
              <input id="street" type="text" class="form-control" placeholder="×œ×“×•×’××”: ×”×¨×¦×œ 5" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">×¢×™×¨ (×—×•×‘×”)</label>
              <input id="city" type="text" class="form-control" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘" />
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">××—×™×¨ ×—×©××œ ×—×•×“×©×™ (â‚ª) <span class="text-muted small">×œ×¤×™ ×”×—×©×‘×•× ×™×ª</span></label>
            <input id="monthlyPrice" type="number" min="0" step="0.01" class="form-control" placeholder="×œ×“×•×’××”: 350" />
          </div>

          <div class="d-grid gap-2 mt-4">
            <button id="btnAnalyze" class="btn btn-primary" onclick="handleAnalyze()">
              <span class="btn-text"><i class="bi bi-cpu me-1"></i>×©×œ×— ×œ× ×™×ª×•×—</span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" id="spinAnalyze" role="status" aria-hidden="true"></span>
            </button>
            <button id="btnSave" class="btn btn-outline-secondary" onclick="handleSave()" disabled>
              <i class="bi bi-save me-1"></i>×©××•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×
            </button>
          </div>

          <div class="mt-2 small-note" id="statusArea"></div>
        </div>
      </div>

      <!-- Right column: Results -->
      <div class="col-lg-7">
        <div id="emptyState" class="card p-4 text-center">
          <div class="display-6 mb-2">ğŸŒ</div>
          <h5 class="mb-2">××™×Ÿ ×¢×“×™×™×Ÿ ×ª×•×¦××•×ª</h5>
          <p class="text-muted mb-0">×”×¢×œ×” ×ª××•× ×” ×•×”×–×Ÿ ×¤×¨×˜×™× ×‘×¦×“ ×©×××œ, ×•×œ××—×¨ ××›×Ÿ ×œ×—×¥ ×¢×œ "×©×œ×— ×œ× ×™×ª×•×—".</p>
        </div>

        <div id="resultsWrap" class="d-none fade-in">
          <!-- KPIs -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3"><div class="kpi"><h6>××¡' ×œ×•×—×•×ª</h6><div class="val" id="kpiPanels">â€“</div></div></div>
            <div class="col-6 col-md-3"><div class="kpi"><h6>×¢×œ×•×ª ×”×ª×§× ×”</h6><div class="val" id="kpiCost">â€“</div></div></div>
            <div class="col-6 col-md-3"><div class="kpi"><h6>×—×™×¡×›×•×Ÿ ×©× ×ª×™</h6><div class="val" id="kpiYearly">â€“</div></div></div>
            <div class="col-6 col-md-3"><div class="kpi"><h6>×”×—×–×¨ (×©× ×™×)</h6><div class="val" id="kpiPayback">â€“</div></div></div>
          </div>

          <!-- Images Tabs -->
          <div class="card p-3 mb-3">
            <ul class="nav nav-tabs results-tabs" id="imgTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-original" data-bs-toggle="tab" data-bs-target="#pane-original" type="button" role="tab">××§×•×¨</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-mask" data-bs-toggle="tab" data-bs-target="#pane-mask" type="button" role="tab">Mask</button>
              </li>
            </ul>
            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="pane-original" role="tabpanel">
                <img id="imgOriginal" class="img-fit" alt="×ª××•× ×ª ××§×•×¨" />
              </div>
              <div class="tab-pane fade" id="pane-mask" role="tabpanel">
                <img id="imgMask" class="img-fit" alt="×ª××•× ×ª ××¡×›×”" />
              </div>
            </div>
          </div>

          <!-- Charts & Details -->
          <div class="card p-3 mb-3">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <h6 class="mb-2"><i class="bi bi-graph-up"></i> ×”×›× ×¡×” ×—×•×“×©×™×ª ×—×–×•×™×”</h6>
                <canvas id="chartMonthly" height="160"></canvas>
              </div>
              <div class="col-12 col-md-6">
                <h6 class="mb-2"><i class="bi bi-graph-up-arrow"></i> ×”×—×–×¨ ××¦×˜×‘×¨</h6>
                <canvas id="chartPayback" height="160"></canvas>
              </div>
            </div>
          </div>

          <div class="card p-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> ×¤×¨×˜×™× × ×•×¡×¤×™×</h6>
            <div class="row g-3 small">
              <div class="col-md-3">
                <div class="text-muted">×¢×™×¨</div>
                <div id="infoCity">â€“</div>
              </div>
              <div class="col-md-5">
                <div class="text-muted">×›×ª×•×‘×ª</div>
                <div id="infoStreet">â€“</div>
              </div>
              <div class="col-md-2">
                <div class="text-muted">Lat</div>
                <div id="infoLat">â€“</div>
              </div>
              <div class="col-md-2">
                <div class="text-muted">Lon</div>
                <div id="infoLon">â€“</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">×¤×¢×•×œ×” ×”×•×©×œ××”</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // State
    let lastResponse = null; // × ×©××•×¨ ××ª ×ª×•×¦××ª /predict ×œ×©×™××•×© ×‘-/save_in_database
    let chartMonthly = null;
    let chartPayback = null;

    // Preview on image select
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    imageInput.addEventListener('change', () => {
      const f = imageInput.files?.[0];
      if (!f) { imagePreview.removeAttribute('src'); return; }
      const url = URL.createObjectURL(f);
      imagePreview.src = url;
    });

    function setLoading(flag) {
      const btn = document.getElementById('btnAnalyze');
      const spin = document.getElementById('spinAnalyze');
      btn.disabled = !!flag;
      spin.classList.toggle('d-none', !flag);
    }

    function showToast(msg, variant = 'dark') {
      const t = document.getElementById('toast');
      const msgEl = document.getElementById('toastMsg');
      t.className = `toast align-items-center text-bg-${variant} border-0`;
      msgEl.textContent = msg;
      const toast = new bootstrap.Toast(t);
      toast.show();
    }

    function formatCurrency(n) {
      if (n === null || n === undefined || isNaN(n)) return 'â€“';
      return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(Number(n));
    }

    async function handleAnalyze() {
      try {
        const file = imageInput.files?.[0];
        const city = document.getElementById('city').value.trim();
        const street = document.getElementById('street').value.trim();
        const monthlyPrice = parseFloat(document.getElementById('monthlyPrice').value);

        if (!file) return showToast('× × ×œ×‘×—×•×¨ ×ª××•× ×”', 'danger');
        if (!city) return showToast('× × ×œ××œ× ×¢×™×¨', 'danger');
        if (isNaN(monthlyPrice) || monthlyPrice < 0) return showToast('××—×™×¨ ×—×•×“×©×™ ××™× ×• ×ª×§×™×Ÿ', 'danger');

        const fm = new FormData();
        fm.append('image', file);
        fm.append('city', city);
        fm.append('electricity_price', monthlyPrice); // ×”×©×¨×ª ××¦×¤×” ×œ×©× ×”×–×”
        // ××•×¤×¦×™×•× ×œ×™: ×©×œ×— ×’× ×¨×—×•×‘ â€“ ×”×©×¨×ª ×™×•×›×œ ×œ×”×ª×¢×œ×
        fm.append('street', street);

        setLoading(true);
        document.getElementById('statusArea').textContent = '××‘×¦×¢ × ×™×ª×•×—...';

        const r = await fetch('/predict', { method: 'POST', body: fm });
        if (!r.ok) throw new Error('×©×’×™××” ××”×©×¨×ª (' + r.status + ')');
        const data = await r.json();
        lastResponse = data; // × ×©××•×¨ ×œ×”××©×š

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('resultsWrap').classList.remove('d-none');

        // KPIs
        document.getElementById('kpiPanels').textContent = data.number_panels ?? 'â€“';
        document.getElementById('kpiCost').textContent = formatCurrency(data.cost);
        document.getElementById('kpiYearly').textContent = formatCurrency(data.income_per_year);
        document.getElementById('kpiPayback').textContent = (data.payback ?? 'â€“');

        // ×ª××•× ×•×ª
        const imgOriginal = document.getElementById('imgOriginal');
        const imgMask = document.getElementById('imgMask');
        imgOriginal.src = data.initial_image ? `data:image/png;base64,${data.initial_image}` : '';
        imgMask.src = data.mask_image ? `data:image/png;base64,${data.mask_image}` : '';

        // ×¤×¨×˜×™×
        document.getElementById('infoCity').textContent = city || 'â€“';
        document.getElementById('infoStreet').textContent = street || 'â€“';
        document.getElementById('infoLat').textContent = (data.lat ?? 'â€“');
        document.getElementById('infoLon').textContent = (data.lon ?? 'â€“');

        // ×’×¨×¤×™×
        const monthly = Array.isArray(data.monthly_income) ? data.monthly_income : [];
        const payback = Array.isArray(data.annual_income) ? data.annual_income : [];

        renderMonthlyChart(monthly);
        renderPaybackChart(payback);

        // ×œ××¤×©×¨ ×©××™×¨×”
        document.getElementById('btnSave').disabled = false;
        document.getElementById('statusArea').textContent = '×”× ×™×ª×•×— ×”×•×©×œ×.';
        showToast('×”× ×™×ª×•×— ×”×•×©×œ× ×‘×”×¦×œ×—×”', 'success');
      } catch (e) {
        console.error(e);
        showToast(e.message || '××™×¨×¢×” ×©×’×™××”', 'danger');
        document.getElementById('statusArea').textContent = '×©×’×™××” ×‘×‘×§×©×”.';
      } finally {
        setLoading(false);
      }
    }

    function renderMonthlyChart(monthly) {
      const ctx = document.getElementById('chartMonthly');
      const labels = monthly.map(x => String(x[0]));
      const values = monthly.map(x => Number(x[1]));
      if (chartMonthly) chartMonthly.destroy();
      chartMonthly = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'â‚ª ×œ×—×•×“×©', data: values }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function renderPaybackChart(payback) {
      const ctx = document.getElementById('chartPayback');
      const labels = payback.map(x => String(x[0]));
      const values = payback.map(x => Number(x[1]));
      if (chartPayback) chartPayback.destroy();
      chartPayback = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: '×™×ª×¨×” ××¦×˜×‘×¨×ª (â‚ª)', data: values, tension: .25 }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
      });
    }

    async function handleSave() {
      try {
        if (!lastResponse) return showToast('××™×Ÿ ×ª×•×¦××•×ª ×œ×©××™×¨×”', 'warning');
        const city = document.getElementById('city').value.trim();
        const street = document.getElementById('street').value.trim();
        const projectName = document.getElementById('projectName').value.trim() || 'Solar Roof';

        const payload = {
          Adress: street,
          city: city,
          number_panels: lastResponse.number_panels,
          monthly_income: lastResponse.monthly_income,
          annual_income: lastResponse.annual_income,
          cost: lastResponse.cost,
          payback: lastResponse.payback,
          income_per_year: lastResponse.income_per_year,
          lat: lastResponse.lat,
          lon: lastResponse.lon,
          // ×ª××•× ×•×ª
          initial_image_base64: lastResponse.initial_image,
          mask_image_base64: lastResponse.mask_image,
          // ××•×¤×¦×™×•× ×œ×™ ×œ×©××™×¨×” ×¦×™×“×™×ª
        };

        const r = await fetch('/save_in_database', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!r.ok) throw new Error('×©××™×¨×” × ×›×©×œ×” (' + r.status + ')');
        const resp = await r.json();
        showToast('× ×©××¨ ×‘×”×¦×œ×—×”! ProjectID: ' + (resp.project_id ?? 'â€”'), 'success');
      } catch (e) {
        console.error(e);
        showToast(e.message || '×©×’×™××” ×‘×©××™×¨×”', 'danger');
      }
    }

    function Get_data_by_address() {
      fetch('/get_data_by_address', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          street: document.getElementById('street').value.trim(),
          city: document.getElementById('city').value.trim()
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          const { array_annual, array_monthly, Cost, PaybackYears, YearIncome, PanelsCount, initial_image, mask_image } = data;
        } else {
          showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'danger');
        }
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
    }
  </script>
</body>
</html>
