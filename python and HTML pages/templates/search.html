<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar View – חיפוש לפי כתובת/שם</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root {
      --brand: #1e6f5c;
      --brand-2: #4ecca3;
      --bg: #e3f6f5;
      --text: #233142;
    }
    body {
      background: linear-gradient(135deg, var(--bg) 0%, #f7fafc 100%);
      font-family: 'Heebo', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--text);
    }
    header { text-align: center; padding: 1.5rem 0 .5rem; }
    .brand-title { font-weight: 700; color: var(--brand); }
    .subtitle { color: #5c6b73; }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    .btn-primary {
      background: var(--brand);
      border-color: var(--brand);
      font-weight: 600;
      border-radius: 10px;
    }
    .btn-outline-secondary { border-radius: 10px; }
    .form-control { border-radius: 10px; }
    .img-fit { width: 100%; height: auto; border-radius: 10px; border: 1px solid #e8f3ef; background:#fff; }
    .kpi {
      text-align: center; padding: 12px; border-radius: 12px;
      background: #ffffff; border: 1px solid #e8f3ef;
    }
    .kpi h6 { color: #6b7c85; margin-bottom: 6px; }
    .kpi .val { font-size: 1.25rem; font-weight: 700; color: var(--brand); }
    .small-note { font-size: .85rem; color: #6c757d; }
    .fade-in { animation: fade .35s ease-in-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: none; } }
  </style>
</head>
<body>

  <header class="container">
    <h1 class="brand-title">Solar View</h1>
    <p class="subtitle">חיפוש פרויקט לפי כתובת או שם, והצגת נתונים מהמסד</p>

    <div class="d-flex justify-content-center mt-2">
      <a href="/" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-right-short me-1"></i> חזרה לדף הראשי
      </a>
    </div>
  </header>

  <main class="container my-3">
    <!-- Search form -->
    <div class="card p-3 p-md-4 mb-3">
      <h5 class="mb-3"><i class="bi bi-search me-2" style="color:var(--brand)"></i>חיפוש לפי כתובת/שם</h5>
      <div class="row g-3">
        <div class="col-sm-4">
          <label class="form-label">עיר (אופציונלי)</label>
          <input id="city" class="form-control" placeholder="למשל: מודיעין" />
        </div>
        <div class="col-sm-8">
          <label class="form-label">רחוב / שם פרויקט</label>
          <input id="street" class="form-control" placeholder="למשל: הרצל 5 או 'אופק'" />
        </div>
      </div>
      <div class="d-flex gap-2 mt-3 align-items-center">
        <button class="btn btn-primary" id="btnSearch">
          <i class="bi bi-search me-1"></i> חפש
        </button>
        <span id="status" class="text-muted small"></span>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="d-none fade-in">
      <!-- KPIs -->
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3"><div class="kpi"><h6>מס' לוחות</h6><div id="kpiPanels" class="val">–</div></div></div>
        <div class="col-6 col-md-3"><div class="kpi"><h6>עלות התקנה</h6><div id="kpiCost" class="val">–</div></div></div>
        <div class="col-6 col-md-3"><div class="kpi"><h6>חיסכון שנתי</h6><div id="kpiYearly" class="val">–</div></div></div>
        <div class="col-6 col-md-3"><div class="kpi"><h6>החזר (שנים)</h6><div id="kpiPayback" class="val">–</div></div></div>
      </div>

      <!-- Images -->
      <div class="card p-3 mb-3">
        <h6 class="mb-2"><i class="bi bi-images me-1" style="color:var(--brand)"></i> תמונות</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted mb-1">תמונת מקור</div>
            <img id="imgOriginal" class="img-fit" alt="תמונת מקור" />
          </div>
          <div class="col-md-6">
            <div class="small text-muted mb-1">מסכה</div>
            <img id="imgMask" class="img-fit" alt="תמונת מסכה" />
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="card p-3 mb-3">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <h6 class="mb-2"><i class="bi bi-graph-up me-1" style="color:var(--brand)"></i> הכנסה חודשית</h6>
            <canvas id="chartMonthly" height="160"></canvas>
          </div>
          <div class="col-12 col-md-6">
            <h6 class="mb-2"><i class="bi bi-graph-up-arrow me-1" style="color:var(--brand)"></i> החזר מצטבר</h6>
            <canvas id="chartAnnual" height="160"></canvas>
          </div>
        </div>
      </div>

      <!-- Details -->
      <div class="card p-3">
        <h6 class="mb-2"><i class="bi bi-info-circle me-1" style="color:var(--brand)"></i> פרטים</h6>
        <div class="row g-3 small">
          <div class="col-md-4"><strong>שם פרויקט:</strong> <span id="infoName">–</span></div>
          <div class="col-md-4"><strong>עיר:</strong> <span id="infoCity">–</span></div>
          <div class="col-md-4"><strong>כתובת:</strong> <span id="infoStreet">–</span></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast (שימושי אם תרצה התראות) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">פעולה הושלמה</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const formatCurrency = n => (n==null||isNaN(n)) ? '–'
      : new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS',maximumFractionDigits:0}).format(Number(n));

    let chartMonthly = null;
    let chartAnnual  = null;

    function setImgFromMaybeBase64OrDataURI(imgEl, value) {
      if (!value) { imgEl.removeAttribute('src'); return; }
      if (typeof value === 'string' && value.startsWith('data:')) { imgEl.src = value; return; }
      imgEl.src = `data:image/png;base64,${value}`; // ברירת־מחדל
    }

    async function Get_data_by_address() {
      const street = el('street').value.trim();
      const city   = el('city').value.trim();
      el('status').textContent = 'מחפש...';
      const r = await fetch('/get_data_by_address', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ street, city })
      });
      el('status').textContent = '';
      if (!r.ok) throw new Error('שגיאת שרת ('+r.status+')');
      return r.json();
    }

    function renderMonthlyChart(pairs) {
      const ctx = el('chartMonthly');
      const labels = (pairs || []).map(p => String(p[0]));
      const values = (pairs || []).map(p => Number(p[1]));
      if (chartMonthly) chartMonthly.destroy();
      chartMonthly = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: '₪ לחודש', data: values }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function renderAnnualChart(pairs) {
      const ctx = el('chartAnnual');
      const labels = (pairs || []).map(p => String(p[0]));
      const values = (pairs || []).map(p => Number(p[1]));
      if (chartAnnual) chartAnnual.destroy();
      chartAnnual = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'יתרה מצטברת (₪)', data: values, tension: .25 }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
      });
    }

    el('btnSearch').addEventListener('click', async () => {
      try {
        const data = await Get_data_by_address();
        if (data.status !== 'success') throw new Error(data.message || 'לא נמצאו תוצאות');

        el('results').classList.remove('d-none');

        // KPIs
        el('kpiPanels').textContent  = data.number_panels ?? data.PanelsCount ?? '–';
        el('kpiCost').textContent    = formatCurrency(data.cost ?? data.Cost);
        el('kpiYearly').textContent  = formatCurrency(data.income_per_year ?? data.YearIncome);
        el('kpiPayback').textContent = (data.payback ?? data.PaybackYears ?? '–');

        // Details
        el('infoName').textContent   = data.project_name ?? '–';
        el('infoCity').textContent   = data.city ?? (el('city').value.trim() || '–');
        el('infoStreet').textContent = data.street ?? (el('street').value.trim() || '–');

        // Images
        setImgFromMaybeBase64OrDataURI(el('imgOriginal'), data.initial_image);
        setImgFromMaybeBase64OrDataURI(el('imgMask'),     data.mask_image);

        // Charts
        renderMonthlyChart(data.array_monthly || []);
        renderAnnualChart (data.array_annual  || []);
      } catch (e) {
        alert(e.message || 'שגיאה בחיפוש');
      }
    });

    // Enter = Search
    ['city','street'].forEach(id=>{
      const node = el(id); if (!node) return;
      node.addEventListener('keydown', e => { if (e.key === 'Enter') el('btnSearch').click(); });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
